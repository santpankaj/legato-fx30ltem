<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Kernel Module Definition .mdef</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="fonts.css" rel="stylesheet" type="text/css" />
<link href="legato.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/javascript">
//<![CDATA[
    // Detect if doc is served by eclipse
    if( ( (window.location.hostname == "127.0.0.1") || (window.location.hostname == "localhost") ) &&
        ( (window.location.port != "") && (window.location.port != 80) && (window.location.port != 443) ) )
    {
        // Inhibit init function from navtree
        initNavTree = function(toroot,relpath) {}
        $(document).ready(function(){
            navTree = document.getElementById("side-nav");
            if(navTree)
            {
                navTree.parentElement.removeChild(navTree);
            }
            $("#doc-content").css('margin-left',10);
        });
    }
//]]>
</script>
<link rel="icon" type="image/png" href="favicon.ico" />
</head>
<body>
<div id="top"><!-- do not remove this div! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo">
    <a href="index.html" title="Legato">
      <img alt="Logo" src="legatoLogo.png"/>
    </a>
    <div id="projectbrief">Simplifying IoT development</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('defFilesMdef.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Kernel Module Definition .mdef </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This topic provides details about Legato AF's Kernel Module Definition file.</p>
<p>The <code></code>.mdef files support 2 methods of building drivers within the Legato AF.</p><ol type="1">
<li>Using <code>pre-built</code> to bundle kernel module binary files.</li>
<li>Using <code>sources</code> to make and bundle .c files into a kernel object.</li>
</ol>
<p>Each method will bundle the kernel module into the system definition (when called in the .sdef) and will be installed on the target when the system is updated.</p>
<dl class="section note"><dt>Note</dt><dd>The <code></code>.mdef must contain <b>either</b> a <code>source</code> or a <code>preBuilt</code> section, not both.</dd></dl>
<p><code></code>.mdef files contain the following sections:</p>
<h1><a class="anchor" id="defFilesMdef_sources"></a>
sources</h1>
<p>The <code>sources:</code> section specifies the path of the source code that is required to build the kernel module binary file. This will build a <code></code>.ko file from the source</p>
<p>Building a driver using <code>sources:</code> </p>
<div class="fragment"><div class="line">sources:</div><div class="line">{</div><div class="line">    mangoh_iot.c</div><div class="line">    green.c</div><div class="line">    eeprom.c</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="defFilesMdef_preBuilt"></a>
preBuilt</h1>
<p>The <code>preBuilt:</code> section specifies the path to the pre-built kernel module binary file. The module binary file specified must have an extension <code></code>.ko.</p>
<p>Building a kernel module binary file from <code>/path/to/module/hello</code>.ko:</p>
<div class="fragment"><div class="line">preBuilt:</div><div class="line">{</div><div class="line">    /path/to/kernel/module/hello.ko</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="defFilesMdef_params"></a>
params</h1>
<p>The optional <code>params:</code> section lists all module parameters that must be provided to the <code>insmod</code> command.</p>
<p>The following code sample will execute this command <code>insmod &lt;module&gt; param1=value1 param2=value2 …</code>: </p><div class="fragment"><div class="line">params:</div><div class="line">{</div><div class="line">    param1 = <span class="stringliteral">&quot;value1&quot;</span></div><div class="line">    param2 = <span class="stringliteral">&quot;value2&quot;</span></div><div class="line">    …</div><div class="line">}</div></div><!-- fragment --><p>The mandatory quotes (" ") around each parameter value indicate a string type.</p>
<h1><a class="anchor" id="defFilesMdef_flags"></a>
flags</h1>
<p>The optional <code>cflags:</code> and <code>ldflags:</code> can be added to list all options that need to be passed to the compiler and linker during the driver build. </p><div class="fragment"><div class="line">cflags:</div><div class="line">{</div><div class="line"><span class="stringliteral">&quot;-I/path/to/custom/includes&quot;</span></div><div class="line">}</div><div class="line"></div><div class="line">ldflags:</div><div class="line">{</div><div class="line"><span class="stringliteral">&quot;-L/path/to/custom/libs&quot;</span></div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="defFilesMdef_load"></a>
load</h1>
<p>Specifies if the module should load automatically at start-up:</p><ul>
<li><b>auto</b> loads automatically by the Supervisor at Legato start-up.</li>
<li><b>manual</b> loads when the dependent app starts. Default is <b>auto</b>.</li>
</ul>
<div class="fragment"><div class="line">load: manual</div></div><!-- fragment --><p>If an app is set to manual start and the app depends on a kernel module set to manual then the module will be installed only when the app is triggered to start and the module will be removed when the app is triggered to stop. For example, if app helloWorld depends on module alpha (which is set to manual load), then alpha will be installed only when helloWorld is started using <code>app</code> <code>start</code> <code>helloWorld</code> and alpha will be removed when helloWorld is stopped using <code>app</code> <code>stop</code> <code>helloWorld</code>.</p>
<h1><a class="anchor" id="defFilesMdef_bundles"></a>
bundles</h1>
<p>Kernel modules might need additional files to work correctly. Examples of files that you would bundle with a kernel module may be binaries or firmware images. You can add files and directories in <code>bundles:</code> section that will be bundled with the kernel module and will be copied from the build host to the target such that they are available to the module at runtime. You can then configure the files using a script when loading and unloading the module.</p>
<div class="fragment"><div class="line">bundles:</div><div class="line">{</div><div class="line">    file:</div><div class="line">    {</div><div class="line">        $CURDIR/bin/a.bin /bin/a.bin</div><div class="line">        $CURDIR/firmware/b.img /firmware/b.img</div><div class="line">    }</div><div class="line"></div><div class="line">    dir:</div><div class="line">    {</div><div class="line">        $CURDIR/dir/  /dir</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>The build system path and target path needs to be specified for each of the files or directories. The build system path is on your <b>dev</b> <b>machine</b> where the file is located at build time. The target path is the file system path on the target where the file will appear at runtime. If the path ends with '/', it means the directory path where the source object (file or directory) will be copied. The destination object will have the same name as the source object. The default file path on the target is located at /legato/systems/current/modules/files/modulename/.</p>
<h1><a class="anchor" id="defFilesMdef_scripts"></a>
scripts</h1>
<p>Lists the installation and removal scripts for the kernel module. It is <b>mandatory</b> to add a <code>scripts:</code> section if you have additional files bundled. The scripts must include <code>insmod</code> and <code>rmmod</code> to handle installation and removal of the modules othewise the modules will not be loaded or unloaded.</p>
<pre class="fragment">scripts:
{
    install:  $CURDIR/scripts/install.sh
    remove:   $CURDIR/scripts/remove.sh
}
</pre><p><code>install:</code> specifies the build system path of the module installation script where the script is located at build time.</p>
<p><code>remove:</code> specifies the build system path of the module removal script where the script is located at build time. The default script file path on the target is located at /legato/system/current/modules/files/modulename/scripts/.</p>
<p>Example of install.sh: </p><pre class="fragment">#!/bin/sh

KO_PATH=$1

insmod $KO_PATH id="first" port=0x330
</pre><p>Example of remove.sh: </p><pre class="fragment">#!/bin/sh

KO_PATH=$1

rmmod $KO_PATH
</pre><dl class="section warning"><dt>Warning</dt><dd>The installation script must handle the loading of the module using <code>insmod</code> and the removal script must handle the unloading of the module using <code>rmmod</code>.</dd></dl>
<h1><a class="anchor" id="defFilesMdef_requires"></a>
requires</h1>
<p>The <code>requires:</code> section specifies various requirements the module needs from its runtime environment.</p>
<h2><a class="anchor" id="defFilesMdef_requireskm"></a>
kernelModules</h2>
<p>Your module may depend on one or more kernel modules to load before it loads. <code>kernelModules:</code> section declares a list of kernel modules that a module depends on. Each entry is a path to another <a class="el" href="defFilesMdef.html">.mdef</a> definition file. This section marks that the module has a requirement on a kernel module but does not add the kernel module to the Legato system. The kernel module needs to be <b>explicitly</b> <b>added</b> to kernelModules: section of your systems <a class="el" href="defFilesSdef.html">.sdef</a>. After the kernel modules are added to the sdef, the modules will be bundled as a part of the parent module and installed with the Legato system. The listed modules will be installed before the parent module itself is installed. In the example below, hello and world kernel modules will be installed before its parent module is installed.</p>
<div class="fragment"><div class="line">requires:</div><div class="line">{</div><div class="line">    kernelModules:</div><div class="line">    {</div><div class="line">       $CURDIR/kernelmodule/hello</div><div class="line">       $CURDIR/kernelmodule/world</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>hello module might further depend on alpha module and the following requires section needs to be added to the hello module. In such case, alpha module will be loaded before hello module is loaded.</p>
<p>Example of requires: kernelModules: section of hello module:</p>
<div class="fragment"><div class="line">requires:</div><div class="line">{</div><div class="line">    kernelModules:</div><div class="line">    {</div><div class="line">       $CURDIR/kernelmodule/alpha</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><dl class="section warning"><dt>Warning</dt><dd>Cyclic dependency must be avoided when designing the kernel module hierarchy. For instance, if module 'a.mdef' is dependent on module 'x.mdef' at some point in the hierarchy then module 'x.mdef' must never be dependent on module 'a.mdef' at any point.</dd></dl>
<p>Copyright (C) Sierra Wireless Inc. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
   <div class="footer">
        <div>
            <a href="https://www.sierrawireless.com/">
                <img src="swi-ico-medium.png" width="24" alt="" />
                &nbsp;Sierra Wireless
            </a>
            &nbsp;-&nbsp;
            Generated by Doxygen 1.8.11
        </div>
    </div>
</body>
</html>
